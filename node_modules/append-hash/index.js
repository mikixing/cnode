
let colors = require('colors');
let path = require('path');
let crypto = require('crypto');
let fs = require('fs');

let map = {};


module.exports = function (src, dest) {
	if (typeof src !== 'string') throw new Error('src 必传');
	if (typeof dest !== 'string') throw new Error('dest 必传');

	let dir = path.dirname(src);
	console.log(`\n----- ${src} -----`.grey)
	let res =fs.readFileSync( src, 'utf-8' ).replace(/\{\{([^\{\}]+)\}\}/g, ($0, url) => {
		url = url.trim().replace(/[\?#]+$/g, '')
		let url2 = path.join(dir, url);
		let hash;
		if (url2 in map) {
			hash = map[url2];
		} else if (fs.existsSync(url2)) {
			hash = map[url2] = md5( fs.readFileSync(url2) ).substring(0, 20);
			console.log(url.green, '->', hash.yellow);
		} else {
			console.warn(url, '不存在');
			return $0;
		}

		return url + '?' + hash;
	});
	console.log(`----- ${dest} -----\n`.grey)

	fs.writeFileSync(dest, res);
}


function md5 (data) {
	return crypto.createHash('md5').update( data ).digest('hex');
}